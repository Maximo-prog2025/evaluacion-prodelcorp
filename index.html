<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Evaluaci√≥n Prodelcorp ‚Äî Acceso restringido</title>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --accent:#0b63d6; --muted:#666; --ok:#0a8a3f; --bad:#d02a2a;
  }
  body{font-family:Inter,system-ui,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111;}
  .wrap{max-width:900px;margin:22px auto;padding:18px}
  header{display:flex;align-items:center;gap:16px;margin-bottom:8px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .chip{background:#f0f6ff;color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:600}
  .timer{margin-left:auto;font-weight:800;color:var(--accent)}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(12,30,60,0.06)}
  .section-title{font-weight:700;margin-top:14px;margin-bottom:6px}
  .question{padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid #eef2f8;background:#fff}
  .qtext{font-size:15px;margin-bottom:8px}
  .options{display:flex;flex-direction:column;gap:8px}
  .option{padding:8px;border-radius:8px;border:1px solid #e6e9ef;cursor:pointer;user-select:none}
  .option input{margin-right:8px}
  .controls{display:flex;gap:8px;align-items:center;margin-top:14px;flex-wrap:wrap}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #dbe9ff}
  .result{margin-top:18px;padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef6ff}
  .login-area{text-align:center;margin-top:80px}
  .denied{text-align:center;color:var(--bad);font-weight:600;margin-top:80px}
  .user-actions{display:flex;gap:8px;align-items:center;margin-left:auto}
  .detail-item{padding:10px;border-radius:8px;border:1px solid #eef2f8;margin-bottom:8px;background:white}
  .ok{border-left:6px solid var(--ok);padding-left:10px}
  .bad{border-left:6px solid var(--bad);padding-left:10px}
  .meta{font-size:13px;color:var(--muted)}
  .small{font-size:13px;padding:6px 10px}
  pre{white-space:pre-wrap;font-family:inherit}
  .welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;text-align:center}
  .welcome h2{font-size:24px;margin-bottom:10px}
  .welcome p{font-size:16px;color:#444;margin-bottom:20px}
  @media (max-width:640px){.wrap{padding:12px}}
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="preguntas.js"></script>
</head>

<body>
<!-- LOGIN -->
<div id="login" class="login-area" style="display:none">
  <h2>üîê Acceso restringido</h2>
  <p>Inicia sesi√≥n con tu cuenta autorizada para acceder al simulador.</p>
  <button id="loginBtn">Iniciar con Google</button>
</div>

<!-- DENEGADO -->
<div id="denied" class="denied" style="display:none">
  ‚ùå Acceso denegado.<br>No est√°s autorizado para usar este simulador.
  <div style="margin-top:12px">
    <button onclick="location.reload()">Volver</button>
  </div>
</div>

<!-- EXAMEN -->
<div class="wrap" id="exam" style="display:none">
  <header>
    <h1>Evaluaci√≥n Prodelcorp</h1>
    <div class="chip" id="userChip">Cargando...</div>
    <div class="user-actions">
      <div class="meta" id="userMeta"></div>
      <button class="ghost small" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </div>
    <div class="timer" id="timer">60:00</div>
  </header>

  <!-- Pantalla de bienvenida -->
  <div id="welcomeScreen" class="card welcome">
    <h2>Bienvenido a tu examen</h2>
    <p>Conc√©ntrate, conf√≠a en tus conocimientos y ¬°adelante!</p>
    <button id="startBtn">Comenzar examen</button>
  </div>

  <!-- √Årea de preguntas -->
  <div class="card" id="card" style="display:none">
    <div id="questionsArea"></div>
    <div class="controls">
      <button id="submitBtn">Finalizar</button>
      <button id="restartBtn" class="ghost">Reiniciar</button>
      <div style="margin-left:auto;font-size:13px;color:var(--muted)">Tiempo total: 60 minutos</div>
    </div>
    <div id="resultArea"></div>
  </div>
</div>

<script>
/* ====== AUTENTICACI√ìN ====== */
const AUTH_USERS = ["maxponcep@gmail.com","consulbf12@gmail.com","victor_41437@hotmail.com"];
const CLIENT_ID = "447366046291-0ted51mtkamjnrj7vv015vb7bvcs39eh.apps.googleusercontent.com";

function parseJwt(token){
  try{
    const base64Url=token.split('.')[1];
    const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const jsonPayload=decodeURIComponent(atob(base64).split('').map(c=>
      '%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload);
  }catch(e){return null;}
}

function iniciarGoogle(){
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
  });
  google.accounts.id.prompt();
}

function handleCredentialResponse(response){
  const data=parseJwt(response.credential);
  if(!data||!data.email)return showDenied();
  const email=data.email;
  const name=data.name||data.email;
  if(AUTH_USERS.includes(email)){
    sessionStorage.setItem("sim_user",JSON.stringify({email,name}));
    showExamFor({email,name});
  }else showDenied();
}

function showDenied(){
  document.getElementById("login").style.display="none";
  document.getElementById("denied").style.display="block";
  document.getElementById("exam").style.display="none";
}

function showExamFor(user){
  document.getElementById("login").style.display="none";
  document.getElementById("denied").style.display="none";
  document.getElementById("exam").style.display="block";
  document.getElementById("userChip").textContent=user.name;
  document.getElementById("userMeta").textContent=user.email;
}

window.onload=()=>{
  const s=sessionStorage.getItem("sim_user");
  if(s){try{showExamFor(JSON.parse(s));return;}catch(e){}}
  document.getElementById("login").style.display="block";
  document.getElementById("loginBtn").addEventListener("click",()=>{iniciarGoogle();});
};

function cerrarSesion(){
  sessionStorage.removeItem("sim_user");
  google.accounts.id.disableAutoSelect();
  location.reload();
}

/* ====== EXAMEN ====== */
function startExam(){
  const questionsArea=document.getElementById("questionsArea");
  const timerEl=document.getElementById("timer");
  const submitBtn=document.getElementById("submitBtn");
  const restartBtn=document.getElementById("restartBtn");
  const resultArea=document.getElementById("resultArea");

  let timeLeft=60*60;
  let timerInterval=null;
  let answered={};

  function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

  function buildUI(){
    questionsArea.innerHTML="";
    let currentBlock="";
    questions.forEach(q=>{
      if(q.Bloque && q.Bloque!==currentBlock){
        currentBlock=q.Bloque;
        const h=document.createElement("div");
        h.className="section-title";
        h.textContent=currentBlock;
        questionsArea.appendChild(h);
      }
      const opts=q.opciones?JSON.parse(JSON.stringify(q.opciones)):(q.options||[]);
      shuffleArray(opts);
      const div=document.createElement("div");
      div.className="question";
      const qtext=document.createElement("div");
      qtext.className="qtext";
      qtext.innerHTML=`<strong>Pregunta ${q.id}.</strong> ${q.Pregunta||q.question}`;
      div.appendChild(qtext);
      const optsDiv=document.createElement("div");
      optsDiv.className="options";
      opts.forEach(o=>{
        const label=document.createElement("label");
        label.className="option";
        const radio=document.createElement("input");
        radio.type="radio";
        radio.name="q_"+q.id;
        radio.value=o.text;
        radio.addEventListener("change",()=>{answered[q.id]=o.text;});
        label.appendChild(radio);
        const span=document.createElement("span");
        span.innerHTML=o.text;
        label.appendChild(span);
        optsDiv.appendChild(label);
      });
      div.appendChild(optsDiv);
      questionsArea.appendChild(div);
    });
  }

  function updateTimer(){
    const mm=String(Math.floor(timeLeft/60)).padStart(2,"0");
    const ss=String(timeLeft%60).padStart(2,"0");
    timerEl.textContent=`${mm}:${ss}`;
  }

  function startTimer(){
    clearInterval(timerInterval);
    updateTimer();
    timerInterval=setInterval(()=>{
      timeLeft--;
      if(timeLeft<=0){clearInterval(timerInterval);finishExam(true);}
      else updateTimer();
    },1000);
  }

  function finishExam(auto=false){
    clearInterval(timerInterval);
    document.querySelectorAll("input[type=radio]").forEach(r=>r.disabled=true);
    submitBtn.disabled=true;
    let correctCount=0;
    questions.forEach(q=>{
      const sel=answered[q.id]||null;
      const correctOpt=(q.opciones||q.options).find(o=>o.isCorrect===true);
      if(sel&&correctOpt&&sel.trim()===correctOpt.text.trim()){correctCount++;}
    });

    let html=`<div class="result"><h3>Resultado</h3>
      <p>Aciertos: <strong>${correctCount}</strong> de ${questions.length}</p>`;
    html+=auto?'<p><em>Se termin√≥ el tiempo.</em></p>':'';
    resultArea.innerHTML=html;
    resultArea.scrollIntoView({behavior:"smooth"});
  }

  submitBtn.onclick=()=>{if(confirm("¬øDeseas entregar el simulacro ahora?"))finishExam(false);};
  restartBtn.onclick=()=>{showWelcome();};

  buildUI();
  startTimer();
}

/* ====== NUEVO: Pantalla de bienvenida ====== */
document.getElementById("startBtn").onclick=()=>{
  document.getElementById("welcomeScreen").style.display="none";
  document.getElementById("card").style.display="block";
  startExam();
};

function showWelcome(){
  document.getElementById("resultArea").innerHTML="";
  document.getElementById("card").style.display="none";
  document.getElementById("welcomeScreen").style.display="flex";
}
</script>
</body>
</html>
