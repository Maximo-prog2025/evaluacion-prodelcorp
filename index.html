<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulacro ‚Äî Acceso restringido</title>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --accent:#0b63d6; --muted:#666; --ok:#0a8a3f; --bad:#d02a2a;
  }
  body{font-family:Inter,system-ui,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111;}
  .wrap{max-width:900px;margin:22px auto;padding:18px}
  header{display:flex;align-items:center;gap:16px;margin-bottom:8px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .chip{background:#f0f6ff;color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:600}
  .timer{margin-left:auto;font-weight:800;color:var(--accent)}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(12,30,60,0.06)}
  .section-title{text-decoration: underline;letter-spacing: 1px;text-align: center;font-weight:700;margin-top:20px;margin-bottom:10px;font-size:16px;color:var(--accent);border-bottom:2px solid #e5edff;padding-bottom:4px;}
  .question{padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid #eef2f8;background:#fff}
  .qtext{font-size:15px;margin-bottom:8px}
  .options{display:flex;flex-direction:column;gap:8px}
  .option{padding:8px;border-radius:8px;border:1px solid #e6e9ef;cursor:pointer;user-select:none}
  .option input{margin-right:8px}
  .controls{display:flex;gap:8px;align-items:center;margin-top:14px;flex-wrap:wrap}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #dbe9ff}
  .result{margin-top:18px;padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef6ff}
  .login-area{text-align:center;margin-top:80px}
  .denied{text-align:center;color:var(--bad);font-weight:600;margin-top:80px}
  .user-actions{display:flex;gap:8px;align-items:center;margin-left:auto}
  .detail-item{padding:10px;border-radius:8px;border:1px solid #eef2f8;margin-bottom:8px;background:white}
  .ok{border-left:6px solid var(--ok);padding-left:10px}
  .bad{border-left:6px solid var(--bad);padding-left:10px}
  .meta{font-size:13px;color:var(--muted)}
  .small{font-size:13px;padding:6px 10px}
  pre{white-space:pre-wrap;font-family:inherit}
  @media (max-width:640px){.wrap{padding:12px}}

  /* Pantalla de bienvenida */
  #welcomeScreen {
    display: none;
    text-align: center;
    padding: 80px 20px;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(40, 85, 161, 0.06);
  }
  #welcomeScreen h2 { color: var(--accent); }
  #welcomeScreen p { color: var(--muted); margin-bottom: 12px; line-height: 1.2; }
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
<!-- LOGIN AREA -->
<div id="login" class="login-area" style="display:none">
  <h2>üîê Acceso restringido</h2>
  <p>Inicia sesi√≥n con tu cuenta autorizada para acceder al simulador.</p>
  <button id="loginBtn">Iniciar con Google</button>
</div>

<!-- ACCESS DENIED -->
<div id="denied" class="denied" style="display:none">
  ‚ùå Acceso denegado.<br>No est√°s autorizado para usar este simulador.
  <div style="margin-top:12px">
    <button onclick="location.reload()">Volver</button>
  </div>
</div>

<!-- EXAM -->
<div class="wrap" id="exam" style="display:none">
  <header>
    <h1>Simulacro ‚Äî Acceso autorizado</h1>
    <div class="chip" id="userChip">Cargando...</div>
    <div class="user-actions">
      <div class="meta" id="userMeta"></div>
      <button class="ghost small" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </div>
    <div class="timer" id="timer">60:00</div>
  </header>

  <!-- Pantalla de bienvenida -->
  <div id="welcomeScreen" >
    <img src="logo.png" alt="Logo OSCE" style="width: 200px; display: block; margin: 0 auto 20px;">
    <h2>Bienvenido al Simulacro del Examen de Certificaci√≥n OECE 2025</h2>
    <p>Recuerda que para aprobar el <strong>NIVEL B√ÅSICO</strong> necesitas de 30 puntos a m√°s,</p>
    <p>para el <strong>NIVEL INTERMEDIO</strong> necesitas de 43 puntos a m√°s y para el <strong>NIVEL AVANZADO</strong> necesitas de 58 puntos a m√°s.</p>
    <p>Para tal efecto, el Simulacro consta de 450 preguntas en tres fases a desarrollarse en 60 minutos:</p>
    <p>1. <strong>Actuaciones Preparatorias:</strong> desde el n√∫mero 1 hasta el 127</p>
    <p>2. <strong>Fase de Selecci√≥n:</strong> desde el n√∫mero 128 hasta el 270</p>
    <p>3. <strong>Fase de Ejecuci√≥n Contractual:</strong> desde el n√∫mero 271 hasta el 450</p>
    <p>Conc√©ntrate, conf√≠a y da lo mejor de ti. PRODELCORP ‚Äî ¬°Constante actualizaci√≥n a tu alcance!</p>
    <button id="startExamBtn">Comenzar</button>
  </div>

  <div class="card" id="card" style="display:none">
    <div id="questionsArea"></div>
    <div class="controls">
      <button id="submitBtn">Finalizar</button>
      <button id="restartBtn" class="ghost">Reiniciar (recargar)</button>
      <div style="margin-left:auto;font-size:13px;color:var(--muted)">Tiempo total: 60 minutos</div>
    </div>
    <div id="resultArea"></div>
  </div>
</div>

<script>
/* ====== CONTROL DE ACCESO ====== */
const AUTH_USERS = ["maxponcep@gmail.com","consulbf12@gmail.com","victor_41437@hotmail.com","ginamu@gmail.com","sminanourb@gmail.com","taniamarisol76@gmail.com",
"cienfuegosquiroz@gmail.com","kellytorresr@gmail.com","jeancarlo.carrillo.urteaga@gmail.com","ingrubi173549@gmail.com","ingefmatos@gmail.com",
"cpcjonathanburgos21@gmail.com"];
const CLIENT_ID = "447366046291-0ted51mtkamjnrj7vv015vb7bvcs39eh.apps.googleusercontent.com";

function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    return JSON.parse(jsonPayload);
  } catch (e) { return null; }
}

function iniciarGoogle() {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
  });
  google.accounts.id.prompt();
}

function handleCredentialResponse(response) {
  const data = parseJwt(response.credential);
  if (!data || !data.email) return showDenied();

  const email = data.email;
  const name = data.name || data.email;

  if (AUTH_USERS.includes(email)) {
    sessionStorage.setItem("sim_user", JSON.stringify({email, name}));
    showExamFor({email, name});
  } else {
    showDenied();
  }
}

function showDenied(){
  document.getElementById("login").style.display="none";
  document.getElementById("denied").style.display="block";
  document.getElementById("exam").style.display="none";
}

function showExamFor(user){
  document.getElementById("login").style.display="none";
  document.getElementById("denied").style.display="none";
  document.getElementById("exam").style.display="block";
  document.getElementById("userChip").textContent=`${user.name}`;
  document.getElementById("userMeta").textContent=user.email;
  document.getElementById("welcomeScreen").style.display="block";

  document.getElementById("startExamBtn").addEventListener("click", ()=>{
    document.getElementById("welcomeScreen").style.display="none";
    document.getElementById("card").style.display="block";
    if(!window._examStarted){window._examStarted=true;startExam();}
  });
}

window.onload=()=>{
  const s=sessionStorage.getItem("sim_user");
  if(s){try{showExamFor(JSON.parse(s));return;}catch(e){}}
  document.getElementById("login").style.display="block";
  document.getElementById("loginBtn").addEventListener("click",()=>{iniciarGoogle();});
  // üëá Agrega esta l√≠nea temporalmente://PARA SALTEAR EL CORREO Y PONER COMO COMENTARIO LAS 4FILAS ANTERIORES
  //showExamFor({name:"Modo prueba", email:"test@local"});
};

function cerrarSesion(){
  sessionStorage.removeItem("sim_user");
  google.accounts.id.disableAutoSelect();
  location.reload();
}

/* ====== SIMULADOR ====== */
function startExam(){
  if (typeof questions === "undefined" || !Array.isArray(questions) || questions.length === 0) {
    alert("‚ö†Ô∏è No se encontraron preguntas en preguntas.js");
    return;
  }

  const questionsArea = document.getElementById("questionsArea");
  const timerEl = document.getElementById("timer");
  const submitBtn = document.getElementById("submitBtn");
  const restartBtn = document.getElementById("restartBtn");
  const resultArea = document.getElementById("resultArea");

  let timeLeft = 60 * 60;
  let timerInterval = null;
  let answered = {};

  function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

  // üü¢ MODIFICACI√ìN AQU√ç ‚Äî ahora usa "q.tema" en lugar de "q.block"
  function buildUI(){
    questionsArea.innerHTML = "";
    let currentTema = "";

    questions.forEach((q) => {
      if(q.tema && q.tema !== currentTema){
        currentTema = q.tema;
        const h = document.createElement("div");
        h.className = "section-title";
       // h.textContent = currentTema;
        h.textContent = `*** ${currentTema.toUpperCase()} ***`;
        questionsArea.appendChild(h);
      }

      const opts = q.options.map(o => ({...o}));
      shuffleArray(opts);
      const div = document.createElement("div");
      div.className = "question";
      const qtext = document.createElement("div");
      qtext.className = "qtext";
      qtext.innerHTML = `<strong>Pregunta ${q.id}.</strong> ${q.question}`;
      div.appendChild(qtext);
      const optsDiv = document.createElement("div");
      optsDiv.className = "options";
      opts.forEach(o => {
        const label = document.createElement("label");
        label.className = "option";
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "q_" + q.id;
        radio.value = o.text;
        radio.addEventListener("change", () => { answered[q.id] = o.text; });
        label.appendChild(radio);
        const span = document.createElement("span");
        span.innerHTML = o.text;
        label.appendChild(span);
        optsDiv.appendChild(label);
      });
      div.appendChild(optsDiv);
      questionsArea.appendChild(div);
    });
  }

  function updateTimerDisplay(){
    const mm = String(Math.floor(timeLeft/60)).padStart(2,"0");
    const ss = String(timeLeft%60).padStart(2,"0");
    timerEl.textContent = `${mm}:${ss}`;
  }

  function startTimer(){
    clearInterval(timerInterval);
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      timeLeft--;
      if(timeLeft <= 0){
        clearInterval(timerInterval);
        finishExam(true);
      } else updateTimerDisplay();
    }, 1000);
  }

  function buildDetail(correctCount, total){
    let html = `<div class="result"><h3>Resultado</h3>
      <p>Aciertos: <strong>${correctCount}</strong> de ${total}</p>`;
    let levelText = "No aplicable (prueba corta)";
    if(total >= 58){
      if(correctCount >= 58) levelText = "Felicitaciones!!! Alcanzaste el Nivel Avanzado.";
      else if(correctCount >= 43) levelText = "Nivel Intermedio ‚Äî ¬°Sigue prepar√°ndote!";
      else if(correctCount >= 30) levelText = "Nivel B√°sico ‚Äî Puedes mejorar.";
      else levelText = "No aprobaste ‚Äî ¬°Sigue intent√°ndolo!";
    }
    html += `<p>Nivel: <strong>${levelText}</strong></p>`;
    html += `<h4>Detalle de tus respuestas</h4>`;
    const answeredQuestions = questions.filter(q => answered[q.id]);
    if (answeredQuestions.length === 0) {
      html += `<p><em>No respondiste ninguna pregunta.</em></p>`;
    } else {
      answeredQuestions.forEach(q => {
        const sel = answered[q.id];
        const correctOpt = q.options.find(o => o.isCorrect === true);
        const correctText = correctOpt ? correctOpt.text : "‚Äî";
        const wasCorrect = sel && sel.trim() === correctText.trim();
        const cls = wasCorrect ? "detail-item ok" : "detail-item bad";
        html += `<div class="${cls}">
          <div style="font-weight:700">Pregunta ${q.id}.</div>
          <div class="meta">${q.question}</div>
          <div style="margin-top:8px"><strong>Tu respuesta:</strong> <pre>${sel}</pre></div>
          <div><strong>Respuesta correcta:</strong> <pre>${correctText}</pre></div>
        </div>`;
      });
    }
    html += `</div>`;
    return html;
  }

  function finishExam(auto=false){
    clearInterval(timerInterval);
    document.querySelectorAll("input[type=radio]").forEach(r => r.disabled = true);
    submitBtn.disabled = true;
    let correctCount = 0;
    questions.forEach(q => {
      const sel = answered[q.id];
      const correctOpt = q.options.find(o => o.isCorrect === true);
      if(correctOpt && sel && sel.trim() === correctOpt.text.trim()) correctCount++;
    });
    resultArea.innerHTML = buildDetail(correctCount, questions.length) + (auto ? '<p><em>Se termin√≥ el tiempo.</em></p>' : '');
    resultArea.scrollIntoView({behavior:"smooth"});
  }

  submitBtn.addEventListener("click", () => {
    if(!confirm("¬øDeseas entregar el simulacro ahora?")) return;
    finishExam(false);
  });
  restartBtn.addEventListener("click", () => {
    if(!confirm("Se reiniciar√° el examen desde la primera pregunta. ¬øContinuar?")) return;
    window.scrollTo({top:0, behavior:"smooth"});
    location.reload();
  });

  buildUI();
  startTimer();
}
</script>

<script src="preguntas.js"></script>
</body>
</html>
